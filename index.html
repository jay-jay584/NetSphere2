<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NetSphere - Social Platform</title>
  <base href="./" target="_blank">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
  
  <!-- FIREBASE SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    
    if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
      firebase.initializeApp(firebaseConfig);
      window.db = firebase.firestore();
      window.auth = firebase.auth();
    } else {
      console.warn("Firebase not configured - using localStorage fallback");
      window.db = null;
      window.auth = null;
    }
  </script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0f0f13;
      --surface: #1a1a20;
      --surface-light: #252530;
      --accent: #00d4ff;
      --accent-secondary: #7000ff;
      --text: #ffffff;
      --text-sec: #a0a0b0;
      --danger: #ff3860;
      --warning: #ffdd57;
      --success: #23d160;
      --guest: #ff9500;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(0, 212, 255, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(112, 0, 255, 0.1) 0%, transparent 20%);
    }
    
    .form-group { margin-bottom: 20px; }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-sec);
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .error-msg {
      color: var(--danger);
      font-size: 0.875rem;
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(255, 56, 96, 0.1);
      border: 1px solid var(--danger);
      border-radius: 8px;
      display: none;
    }
    .error-msg.show { display: block; animation: shake 0.5s ease-in-out; }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    .logo-container {
      position: relative;
      width: 50px;
      height: 50px;
      cursor: pointer;
    }
    
    .logo-sphere {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      animation: rotate 10s linear infinite;
    }
    
    @keyframes rotate {
      from { transform: rotateY(0deg) rotateX(10deg); }
      to { transform: rotateY(360deg) rotateX(10deg); }
    }
    
    .logo-ring {
      position: absolute;
      width: 100%;
      height: 100%;
      border: 3px solid var(--accent);
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.5), inset 0 0 20px rgba(0, 212, 255, 0.2);
    }
    
    .logo-ring:nth-child(1) { transform: rotateY(0deg); }
    .logo-ring:nth-child(2) { transform: rotateY(60deg); }
    .logo-ring:nth-child(3) { transform: rotateY(120deg); }
    
    .logo-n {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Poppins', sans-serif;
      font-weight: 800;
      font-size: 1.5rem;
      color: var(--text);
      text-shadow: 0 0 10px var(--accent);
      z-index: 10;
      pointer-events: none;
    }
    
    .logo-pulse {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 2px solid var(--accent);
      animation: pulse 2s ease-out infinite;
      opacity: 0;
    }
    
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
      100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
    }
    
    #loading {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      gap: 20px;
    }
    
    .loading-text {
      font-family: 'Poppins', sans-serif;
      font-size: 1.5rem;
      background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 2s linear infinite;
    }
    
    @keyframes shimmer {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }
    
    .nav {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: rgba(15, 15, 19, 0.8);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      z-index: 100;
      padding: 0 20px;
    }
    
    .nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 70px;
    }
    
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      position: relative;
    }
    
    .brand-text {
      font-family: 'Poppins', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .click-hint {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.7rem;
      color: var(--accent);
      opacity: 0;
      transition: opacity 0.3s;
      white-space: nowrap;
      background: rgba(0,0,0,0.8);
      padding: 4px 8px;
      border-radius: 4px;
      pointer-events: none;
    }
    .click-hint.show { opacity: 1; }
    
    .nav-links {
      display: flex;
      gap: 8px;
    }
    
    .nav-link {
      padding: 10px 20px;
      border-radius: 20px;
      color: var(--text-sec);
      font-weight: 500;
      transition: all 0.3s;
      cursor: pointer;
      border: none;
      background: transparent;
      font-family: inherit;
      font-size: 0.95rem;
      position: relative;
      overflow: hidden;
    }
    .nav-link:hover {
      color: var(--text);
      background: rgba(255,255,255,0.05);
    }
    .nav-link.dev {
      background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
      color: white;
      font-weight: 600;
    }
    
    .main {
      padding-top: 90px;
      max-width: 600px;
      margin: 0 auto;
      padding-bottom: 40px;
      padding-left: 20px;
      padding-right: 20px;
    }
    .main.wide { max-width: 1200px; }
    
    .card {
      background: var(--surface);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.05);
      animation: fadeIn 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .btn {
      background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      position: relative;
      overflow: hidden;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
    }
    .btn-outline {
      background: transparent;
      border: 2px solid rgba(255,255,255,0.1);
      color: var(--text);
    }
    .btn-outline:hover {
      border-color: var(--accent);
      background: rgba(0, 212, 255, 0.1);
    }
    .btn-danger {
      background: var(--danger);
    }
    .btn-warning {
      background: var(--warning);
      color: var(--bg);
    }
    .btn-guest {
      background: var(--guest);
      color: white;
    }
    .btn-guest:hover {
      box-shadow: 0 10px 30px rgba(255, 149, 0, 0.3);
    }
    .btn-permanent {
      background: linear-gradient(135deg, var(--success), #1aa352);
      color: white;
    }
    .btn-permanent:hover {
      box-shadow: 0 10px 30px rgba(35, 209, 96, 0.3);
    }
    .btn-small {
      padding: 6px 12px;
      font-size: 0.875rem;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      font-size: 1rem;
      font-family: inherit;
      outline: none;
      transition: all 0.3s;
      background: var(--surface-light);
      color: var(--text);
    }
    input:focus, textarea:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }
    
    /* Auth Page - Single scrollable page */
    .auth-page {
      min-height: 100vh;
      padding: 40px 20px;
      position: relative;
      overflow-x: hidden;
    }
    
    .auth-bg {
      position: fixed;
      inset: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(112, 0, 255, 0.1) 0%, transparent 50%);
      animation: bgRotate 20s linear infinite;
      z-index: -1;
    }
    @keyframes bgRotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .auth-container {
      max-width: 420px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 40px;
      padding-bottom: 60px;
    }
    
    .auth-card {
      background: var(--surface);
      border-radius: 32px;
      padding: 40px;
      border: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(20px);
      position: relative;
    }
    
    .auth-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .auth-divider {
      display: flex;
      align-items: center;
      margin: 24px 0;
      color: var(--text-sec);
      font-size: 0.875rem;
    }
    .auth-divider::before,
    .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: rgba(255,255,255,0.1);
      margin: 0 16px;
    }
    
    .scroll-indicator {
      text-align: center;
      color: var(--accent);
      font-size: 0.875rem;
      margin-top: 30px;
      animation: bounce 2s infinite;
      font-weight: 600;
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    
    .dev-reveal {
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(112, 0, 255, 0.1));
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      display: none;
      animation: slideDown 0.3s ease;
    }
    .dev-reveal.show { display: block; }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .avatar-container {
      position: relative;
      display: inline-block;
    }
    
    .avatar {
      width: 48px; height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      flex-shrink: 0;
      border: 2px solid rgba(255,255,255,0.1);
      overflow: hidden;
      position: relative;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .avatar.large {
      width: 120px;
      height: 120px;
      font-size: 3rem;
    }
    .avatar.bot {
      background: linear-gradient(135deg, #00ff88, #00cc6a);
    }
    .avatar.guest {
      background: linear-gradient(135deg, var(--guest), #cc7700);
    }
    
    .avatar-upload {
      position: absolute;
      bottom: 0;
      right: 0;
      background: var(--accent);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 3px solid var(--surface);
      font-size: 0.875rem;
    }
    
    .profile-header { position: relative; }
    
    .cover-image {
      height: 200px;
      background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
      border-radius: 20px 20px 0 0;
      position: relative;
      overflow: hidden;
    }
    .cover-image::after {
      content: '';
      position: absolute;
      inset: 0;
      background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></svg>');
      opacity: 0.3;
    }
    
    .profile-info {
      padding: 0 24px 24px;
      position: relative;
    }
    
    .profile-avatar-wrapper {
      margin-top: -60px;
      position: relative;
      display: inline-block;
    }
    
    .profile-name {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
    }
    
    .profile-stats {
      display: flex;
      gap: 24px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .profile-stats > div {
      display: flex;
      flex-direction: column;
    }
    .profile-stats strong {
      font-size: 1.25rem;
      color: var(--text);
    }
    .profile-stats span {
      font-size: 0.875rem;
      color: var(--text-sec);
    }
    
    .post-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .post-meta h4 {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .post-meta span {
      color: var(--text-sec);
      font-size: 0.875rem;
    }
    
    .verified, .admin-badge, .bot-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px; height: 16px;
      border-radius: 50%;
      font-size: 10px;
    }
    .verified { background: var(--accent); color: black; }
    .admin-badge { background: var(--danger); color: white; }
    .bot-badge { background: #00ff88; color: black; }
    
    .post-content {
      margin-bottom: 16px;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    
    .post-media {
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .post-media img, .post-media video {
      width: 100%;
      display: block;
    }
    
    .post-actions {
      display: flex;
      gap: 20px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .post-action {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-sec);
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }
    .post-action:hover { color: var(--accent); }
    .post-action.liked { color: var(--danger); }
    
    .create-post {
      display: flex;
      gap: 16px;
    }
    .create-post-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .dev-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    .dev-card {
      background: var(--surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 20px;
    }
    .dev-card h3 {
      margin-bottom: 16px;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
      font-family: 'Poppins', sans-serif;
    }
    
    .log-container {
      background: var(--bg);
      border-radius: 12px;
      padding: 16px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      gap: 8px;
    }
    .log-time { color: var(--text-sec); font-size: 0.75rem; }
    .log-type { color: var(--accent); font-weight: bold; }
    .log-msg { color: var(--text); }
    
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      backdrop-filter: blur(10px);
    }
    .modal-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }
    .modal {
      background: var(--surface);
      border-radius: 24px;
      padding: 24px;
      width: 100%;
      max-width: 500px;
      border: 1px solid rgba(255,255,255,0.1);
      transform: scale(0.9);
      transition: transform 0.3s;
    }
    .modal-overlay.show .modal {
      transform: scale(1);
    }
    
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast {
      background: var(--surface);
      color: var(--text);
      padding: 16px 24px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      animation: slideIn 0.3s ease;
      max-width: 400px;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 12px;
      backdrop-filter: blur(20px);
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .toast.error { border-left: 4px solid var(--danger); }
    .toast.success { border-left: 4px solid var(--success); }
    .toast.warning { border-left: 4px solid var(--warning); }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .secret-input {
      letter-spacing: 0.5em;
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
      background: var(--bg);
      border: 2px solid rgba(0, 212, 255, 0.3);
    }
    
    .impersonation-banner {
      background: linear-gradient(90deg, rgba(255, 221, 87, 0.2), rgba(255, 221, 87, 0.05));
      border: 1px solid var(--warning);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    
    .bot-banner {
      background: linear-gradient(90deg, rgba(0, 255, 136, 0.2), rgba(0, 255, 136, 0.05));
      border: 1px solid #00ff88;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    
    .guest-banner {
      background: linear-gradient(90deg, rgba(255, 149, 0, 0.2), rgba(255, 149, 0, 0.05));
      border: 1px solid var(--guest);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    
    .create-account-hint {
      text-align: center;
      margin-top: 30px;
      padding-top: 30px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .create-account-hint h3 {
      color: var(--success);
      font-size: 1.25rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .create-account-hint p {
      color: var(--text-sec);
      font-size: 0.875rem;
    }
    
    .arrow-down {
      font-size: 2rem;
      color: var(--accent);
      margin-top: 10px;
      animation: bounce 2s infinite;
    }
    
    @media (max-width: 768px) {
      .nav-links { display: none; }
      .dev-grid { grid-template-columns: 1fr; }
      .auth-card { padding: 24px; }
    }
    
    .hidden { display: none !important; }
    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .gap-2 { gap: 8px; }
    .mt-2 { margin-top: 8px; }
    .mt-4 { margin-top: 16px; }
    .w-full { width: 100%; }
    
    .badge {
      display: inline-flex;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 4px;
    }
    .badge-dev { background: var(--accent); color: black; }
    .badge-permanent { background: var(--danger); color: white; }
    .badge-shadow { background: #333; color: #999; }
    .badge-bot { background: #00ff88; color: black; }
    .badge-guest { background: var(--guest); color: white; }
    
    .settings-section {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .settings-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-sec);
    }
    
    .media-btn {
      padding: 8px 16px;
      border-radius: 8px;
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.2);
      transition: all 0.3s;
    }
    .media-btn:hover {
      background: rgba(0, 212, 255, 0.2);
    }
    
    .comment {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    .avatar.small {
      width: 32px;
      height: 32px;
      font-size: 0.875rem;
    }
    
    .bot-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
  </style>
<base target="_blank">
</head>
<body>
  <div id="loading">
    <div class="logo-container" style="width: 80px; height: 80px;">
      <div class="logo-sphere">
        <div class="logo-ring"></div>
        <div class="logo-ring"></div>
        <div class="logo-ring"></div>
        <div class="logo-pulse"></div>
      </div>
      <div class="logo-n">N</div>
    </div>
    <div class="loading-text">NetSphere</div>
  </div>
  
  <div id="app" style="display:none;"></div>
  <div class="toast-container" id="toast-container"></div>

  <script>
    'use strict';
    
    const SECRET_CODE = '020212';
    const LOGO_CLICKS_REQUIRED = 20;
    let logoClickCount = 0;
    let devHintUnlocked = localStorage.getItem('ns_dev_unlocked') === 'true';
    const useFirebase = window.db !== null;
    
    // Bot control state
    let botControlMode = false;
    let controlledBotId = null;
    
    const SystemLog = {
      logs: JSON.parse(localStorage.getItem('ns_logs') || '[]'),
      add(type, message, data = {}) {
        const entry = {
          id: Date.now(),
          time: new Date().toISOString(),
          type,
          message,
          data,
          user: currentUser?.username || 'anonymous'
        };
        this.logs.unshift(entry);
        if (this.logs.length > 100) this.logs.pop();
        localStorage.setItem('ns_logs', JSON.stringify(this.logs));
        if (useFirebase) {
          window.db.collection('logs').add(entry).catch(() => {});
        }
      },
      getLogs(filter = null) {
        if (filter) return this.logs.filter(l => l.type === filter);
        return this.logs;
      },
      clear() {
        this.logs = [];
        localStorage.setItem('ns_logs', JSON.stringify(this.logs));
      },
      export() {
        return JSON.stringify(this.logs, null, 2);
      }
    };
    
    const DB = {
      KEYS: {
        USERS: 'ns_users_v4',
        POSTS: 'ns_posts_v4',
        CURRENT_USER: 'ns_current_v4',
        BOTS: 'ns_bots_v1'
      },
      cache: { users: null, posts: null, bots: null },
      
      async init() {
        if (useFirebase) {
          await this.loadFromFirebase();
        } else {
          this.initLocalStorage();
        }
        // Keep bots online
        this.maintainBots();
        setInterval(() => this.maintainBots(), 30000);
      },
      
      initLocalStorage() {
        const users = this.getUsers();
        if (!users.find(u => u.username === 'jayjay')) {
          users.push({
            id: 'dev-' + Date.now(),
            username: 'jayjay',
            email: 'dev@netsphere.com',
            password: '2012!',
            displayName: 'JayJay',
            bio: 'System Administrator üë®‚Äçüíª | NetSphere Creator',
            avatar: null,
            cover: null,
            isVerified: true,
            isAdmin: true,
            isDev: true,
            isOnline: true,
            status: 'online',
            isBot: false,
            isGuest: false,
            createdAt: new Date().toISOString(),
            followers: [],
            following: [],
            posts: 0,
            banned: false,
            shadowBanned: false,
            banReason: null,
            lastIP: null,
            metadata: {}
          });
          this.saveUsers(users);
          SystemLog.add('SYSTEM', 'Dev account initialized');
        }
      },
      
      async loadFromFirebase() {
        try {
          const usersSnapshot = await window.db.collection('users').get();
          this.cache.users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          const postsSnapshot = await window.db.collection('posts').orderBy('createdAt', 'desc').get();
          this.cache.posts = postsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          
          if (!this.cache.users.find(u => u.username === 'jayjay')) {
            await this.createUser({
              username: 'jayjay',
              email: 'dev@netsphere.com',
              password: '2012!',
              displayName: 'JayJay',
              bio: 'System Administrator üë®‚Äçüíª | NetSphere Creator',
              isVerified: true,
              isAdmin: true,
              isDev: true,
              isBot: false,
              isGuest: false
            });
          }
        } catch (e) {
          console.error('Firebase load error:', e);
          this.initLocalStorage();
        }
      },
      
      maintainBots() {
        const users = this.getUsers();
        let updated = false;
        users.forEach(u => {
          if (u.isBot && !u.isOnline) {
            u.isOnline = true;
            u.lastActive = new Date().toISOString();
            updated = true;
          }
        });
        if (updated) this.saveUsers(users);
      },
      
      getUsers() {
        if (useFirebase && this.cache.users) return this.cache.users;
        try { return JSON.parse(localStorage.getItem(this.KEYS.USERS)) || []; }
        catch(e) { return []; }
      },
      getPosts() {
        if (useFirebase && this.cache.posts) return this.cache.posts;
        try { return JSON.parse(localStorage.getItem(this.KEYS.POSTS)) || []; }
        catch(e) { return []; }
      },
      getCurrentUser() {
        try { return JSON.parse(localStorage.getItem(this.KEYS.CURRENT_USER)); }
        catch(e) { return null; }
      },
      
      async saveUsers(users) {
        this.cache.users = users;
        localStorage.setItem(this.KEYS.USERS, JSON.stringify(users));
        if (useFirebase) {
          const batch = window.db.batch();
          users.forEach(user => {
            const ref = window.db.collection('users').doc(user.id);
            batch.set(ref, user);
          });
          await batch.commit().catch(() => {});
        }
      },
      async savePosts(posts) {
        this.cache.posts = posts;
        localStorage.setItem(this.KEYS.POSTS, JSON.stringify(posts));
        if (useFirebase) {
          const batch = window.db.batch();
          posts.forEach(post => {
            const ref = window.db.collection('posts').doc(post.id);
            batch.set(ref, post);
          });
          await batch.commit().catch(() => {});
        }
      },
      saveCurrentUser(user) {
        localStorage.setItem(this.KEYS.CURRENT_USER, JSON.stringify(user));
      },
      
      async createUser(userData) {
        const users = this.getUsers();
        const newUser = {
          id: useFirebase ? window.db.collection('users').doc().id : Utils.generateId(),
          ...userData,
          createdAt: new Date().toISOString()
        };
        users.push(newUser);
        await this.saveUsers(users);
        return newUser;
      },
      async updateUser(userId, updates) {
        const users = this.getUsers();
        const idx = users.findIndex(u => u.id === userId);
        if (idx !== -1) {
          users[idx] = { ...users[idx], ...updates };
          await this.saveUsers(users);
          return users[idx];
        }
        return null;
      },
      async deleteUser(userId) {
        const users = DB.getUsers().filter(u => u.id !== userId);
        const posts = DB.getPosts().filter(p => p.userId !== userId);
        await this.saveUsers(users);
        await this.savePosts(posts);
        return true;
      },
      
      exportAll() {
        return {
          users: this.getUsers(),
          posts: this.getPosts(),
          logs: SystemLog.logs,
          exportedAt: new Date().toISOString()
        };
      },
      importAll(data) {
        try {
          if (data.users) this.saveUsers(data.users);
          if (data.posts) this.savePosts(data.posts);
          if (data.logs) {
            SystemLog.logs = data.logs;
            localStorage.setItem('ns_logs', JSON.stringify(data.logs));
          }
          return true;
        } catch(e) {
          return false;
        }
      }
    };
    
    let currentUser = DB.getCurrentUser();
    let currentMediaFile = null;
    let impersonatingUser = null;
    
    const Utils = {
      generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
      },
      formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        if (minutes < 1) return 'Just now';
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days < 7) return `${days}d ago`;
        return date.toLocaleDateString();
      },
      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },
      showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        let icon = '‚ÑπÔ∏è';
        if (type === 'error') icon = '‚ùå';
        if (type === 'success') icon = '‚úÖ';
        if (type === 'warning') icon = '‚ö†Ô∏è';
        toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      },
      formatBytes(bytes, decimals = 2) {
        if (!bytes) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
      }
    };
    
    const Router = {
      navigate(path) {
        window.location.hash = path;
      },
      handle() {
        const hash = window.location.hash.slice(1) || '/';
        const [route, ...params] = hash.split('/');
        
        if (!currentUser && route !== 'login') {
          this.showAuth();
          return;
        }
        
        if (currentUser && route === 'login') {
          this.navigate('/');
          return;
        }
        
        if (currentUser) {
          SystemLog.add('NAVIGATE', `Viewed ${route || 'home'}`, { route, params });
        }
        
        switch(route) {
          case 'profile':
            Views.showProfile(params[0] || currentUser.username);
            break;
          case 'dev':
            if (currentUser?.isDev) Views.showDevPanel();
            else this.navigate('/');
            break;
          case 'settings':
            Views.showSettings();
            break;
          default:
            Views.showHome();
        }
      },
      
      showAuth() {
        // Show combined auth page
        document.getElementById('app').innerHTML = Views.renderAuthPage();
        Views.attachAuthListeners();
      }
    };
    
    window.handleLogoClick = function() {
      logoClickCount++;
      const hint = document.getElementById('click-hint');
      if (hint) {
        hint.textContent = `${LOGO_CLICKS_REQUIRED - logoClickCount} clicks to unlock...`;
        hint.classList.add('show');
        setTimeout(() => hint && hint.classList.remove('show'), 1500);
      }
      if (logoClickCount >= LOGO_CLICKS_REQUIRED) {
        logoClickCount = 0;
        Views.showSecretModal();
      }
    };
    
    window.checkSecretCode = function() {
      const input = document.getElementById('secret-code').value;
      if (input === SECRET_CODE) {
        devHintUnlocked = true;
        localStorage.setItem('ns_dev_unlocked', 'true');
        document.querySelector('.modal-overlay').remove();
        Utils.showToast('üîì Developer access granted!', 'success');
        SystemLog.add('SECURITY', 'Dev access unlocked via secret code');
        Router.showAuth();
      } else {
        const error = document.getElementById('code-error');
        if (error) {
          error.style.display = 'block';
          error.textContent = '‚ùå Invalid code';
        }
        document.getElementById('secret-code').value = '';
        SystemLog.add('SECURITY', 'Failed dev access attempt');
      }
    };
    
    const Views = {
      async init() {
        await DB.init();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        
        if (currentUser) {
          const users = DB.getUsers();
          const idx = users.findIndex(u => u.id === currentUser.id);
          if (idx !== -1) {
            users[idx].isOnline = true;
            users[idx].lastActive = new Date().toISOString();
            users[idx].lastIP = '192.168.x.' + Math.floor(Math.random() * 255);
            await DB.saveUsers(users);
            currentUser = users[idx];
            DB.saveCurrentUser(currentUser);
          }
          SystemLog.add('AUTH', 'User logged in', { username: currentUser.username });
          Router.handle();
        } else {
          Router.showAuth();
        }
      },
      
      renderLogo() {
        return `
          <div class="logo-container" onclick="handleLogoClick()">
            <div class="logo-sphere">
              <div class="logo-ring"></div>
              <div class="logo-ring"></div>
              <div class="logo-ring"></div>
              <div class="logo-pulse"></div>
            </div>
            <div class="logo-n">N</div>
            <span class="click-hint" id="click-hint">20 clicks to unlock...</span>
          </div>
        `;
      },
      
      renderAuthPage() {
        return `
          <div class="auth-page">
            <div class="auth-bg"></div>
            <div class="auth-container">
              
              <!-- TOP SECTION: Login & Guest -->
              <div class="auth-card">
                <div class="auth-header">
                  <div style="display:inline-block; margin-bottom:16px;">
                    ${this.renderLogo()}
                  </div>
                  <h1 style="font-family: Poppins; font-size:2rem; margin-bottom:8px;">NetSphere</h1>
                  <p style="color:var(--text-sec);">Your World, One Scroll</p>
                </div>
                
                <div class="dev-reveal ${devHintUnlocked ? 'show' : ''}">
                  <strong style="color:var(--accent);">üë®‚Äçüíª Developer Access Granted</strong><br>
                  <div style="margin-top:8px; font-size:0.9rem;">
                    Username: <code style="background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px;">jayjay</code><br>
                    Password: <code style="background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px;">2012!</code>
                  </div>
                  <button class="btn w-full mt-2" onclick="document.getElementById('login-username').value='jayjay';document.getElementById('login-password').value='2012!'">Auto-fill Credentials</button>
                </div>
                
                <div id="login-error" class="error-msg"></div>
                
                <form id="login-form" onsubmit="event.preventDefault(); return false;">
                  <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="login-username" required autofocus placeholder="Enter username">
                  </div>
                  <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" required placeholder="Enter password">
                  </div>
                  <button type="button" class="btn w-full" onclick="Auth.handleLogin(event)">Log In</button>
                </form>
                
                <div class="auth-divider">or continue as</div>
                
                <button type="button" class="btn btn-guest w-full" onclick="Auth.loginAsGuest()">
                  üë§ Guest (Temporary)
                </button>
                
                ${!devHintUnlocked ? '<p style="text-align:center; margin-top:12px; font-size:0.75rem; color:var(--text-sec); opacity:0.6;">üí° Hint: The logo holds secrets...</p>' : ''}
                
                <!-- SCROLL HINT -->
                <div class="create-account-hint">
                  <div class="arrow-down">üëá</div>
                  <h3>üìù Create Permanent Account</h3>
                  <p>Scroll down to make a permanent account</p>
                </div>
              </div>
              
              <!-- BOTTOM SECTION: Create Permanent Account (Scroll down to see) -->
              <div class="auth-card" style="border: 2px solid var(--success); background: linear-gradient(135deg, rgba(35, 209, 96, 0.05), var(--surface));">
                <div class="auth-header">
                  <h2 style="font-family: Poppins; font-size:1.75rem; margin-bottom:8px; color: var(--success);">Create Permanent Account</h2>
                  <p style="color:var(--text-sec);">Join the network forever</p>
                </div>
                
                <div id="register-error" class="error-msg"></div>
                
                <form id="register-form" onsubmit="event.preventDefault(); return false;">
                  <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="reg-username" required pattern="[a-zA-Z0-9_]+" placeholder="Choose a username">
                  </div>
                  <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="reg-password" required minlength="4" placeholder="Choose a password">
                  </div>
                  <button type="button" class="btn btn-permanent w-full" onclick="Auth.handleRegister(event)">
                    üíæ Permanent Save
                  </button>
                </form>
                
                <p style="text-align:center; margin-top:20px; font-size:0.875rem; color:var(--text-sec);">
                  By creating an account, you agree to our Terms of Service<br>
                  <span style="color: var(--success); font-weight: 600;">Your data will be saved permanently</span>
                </p>
              </div>
              
            </div>
          </div>
        `;
      },
      
      attachAuthListeners() {
        // Any additional listeners can be attached here
      },
      
      renderNav() {
        const isDev = currentUser?.isDev;
        const isBot = currentUser?.isBot;
        const isGuest = currentUser?.isGuest;
        
        let statusBadge = '';
        if (isBot) statusBadge = '<span style="color:#00ff88; font-size:0.75rem;">ü§ñ BOT MODE</span>';
        else if (isGuest) statusBadge = '<span style="color:var(--guest); font-size:0.75rem;">üë§ GUEST</span>';
        else if (isDev) statusBadge = '<span style="color:var(--accent); font-size:0.75rem;">üõ°Ô∏è DEV</span>';
        
        return `
          <nav class="nav">
            <div class="nav-inner">
              <div class="brand">
                ${this.renderLogo()}
                <span class="brand-text">NetSphere</span>
              </div>
              <div class="nav-links">
                <button class="nav-link" onclick="Router.navigate('/')">üè† Home</button>
                ${!isGuest ? `<button class="nav-link" onclick="Router.navigate('profile/${currentUser.username}')">üë§ Profile</button>` : ''}
                ${!isGuest ? `<button class="nav-link" onclick="Router.navigate('settings')">‚öôÔ∏è Settings</button>` : ''}
                ${isDev ? `<button class="nav-link dev" onclick="Router.navigate('dev')">üõ°Ô∏è Dev</button>` : ''}
                <button class="nav-link" onclick="Auth.logout()">üö™ Logout</button>
              </div>
            </div>
          </nav>
          ${statusBadge ? `<div style="position:fixed; top:70px; right:20px; z-index:99; background:var(--surface); padding:4px 12px; border-radius:20px; border:1px solid rgba(255,255,255,0.1);">${statusBadge}</div>` : ''}
        `;
      },
      
      showSecretModal() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay show';
        modal.innerHTML = `
          <div class="modal">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
              <h2 style="color:var(--accent);">üîí Developer Access</h2>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()" style="background:none; border:none; color:var(--text-sec); font-size:1.5rem; cursor:pointer;">√ó</button>
            </div>
            <p style="margin-bottom:20px; color:var(--text-sec);">Enter the secret code to unlock developer features.</p>
            <div id="code-error" style="display:none; background:rgba(255,56,96,0.2); color:var(--danger); padding:12px; border-radius:8px; margin-bottom:16px; border:1px solid var(--danger);"></div>
            <input type="password" id="secret-code" class="secret-input" placeholder="000000" maxlength="6">
            <button class="btn w-full mt-4" onclick="checkSecretCode()">Unlock Access</button>
          </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('secret-code').focus();
      },
      
      showSettings() {
        if (currentUser.isGuest) {
          Utils.showToast('Guests cannot access settings', 'error');
          Router.navigate('/');
          return;
        }
        
        document.getElementById('app').innerHTML = `
          ${this.renderNav()}
          <main class="main">
            <div class="card">
              <h2 style="margin-bottom:20px;">‚öôÔ∏è Settings</h2>
              
              <div class="settings-section">
                <h3 style="margin-bottom:16px; color:var(--accent);">Profile Picture</h3>
                <div style="display:flex; align-items:center; gap:20px; margin-bottom:16px;">
                  <div class="avatar-container">
                    <div class="avatar large ${currentUser.isBot ? 'bot' : ''} ${currentUser.isGuest ? 'guest' : ''}" id="settings-avatar">
                      ${currentUser.avatar ? `<img src="${currentUser.avatar}">` : currentUser.displayName[0].toUpperCase()}
                    </div>
                    <label class="avatar-upload" style="cursor:pointer;">
                      üì∑
                      <input type="file" accept="image/*" style="display:none;" onchange="Users.updateAvatar(event)">
                    </label>
                  </div>
                  <div>
                    <p style="color:var(--text-sec); font-size:0.875rem;">Click the camera icon to upload a new profile picture</p>
                    <button class="btn btn-small btn-outline mt-2" onclick="Users.removeAvatar()" ${!currentUser.avatar ? 'disabled' : ''}>Remove Photo</button>
                  </div>
                </div>
              </div>
              
              <div class="settings-section">
                <h3 style="margin-bottom:16px; color:var(--accent);">Profile Information</h3>
                <form id="settings-form" onsubmit="event.preventDefault(); return false;">
                  <div class="form-group">
                    <label>Display Name</label>
                    <input type="text" id="settings-name" value="${currentUser.displayName}">
                  </div>
                  <div class="form-group">
                    <label>Bio</label>
                    <textarea id="settings-bio" rows="3" placeholder="Tell us about yourself...">${currentUser.bio || ''}</textarea>
                  </div>
                  <button type="button" class="btn" onclick="Users.saveSettings(event)">Save Changes</button>
                </form>
              </div>
              
              <div class="settings-section">
                <h3 style="margin-bottom:16px; color:var(--danger);">Danger Zone</h3>
                <button class="btn btn-danger btn-outline" onclick="Users.deleteAccount()">Delete Account</button>
              </div>
            </div>
          </main>
        `;
      },
      
      showHome() {
        const posts = DB.getPosts().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        let banner = '';
        if (botControlMode && controlledBotId) {
          const bot = DB.getUsers().find(u => u.id === controlledBotId);
          banner = `
            <div class="bot-banner">
              <div>
                <strong style="color:#00ff88;">ü§ñ Controlling Bot: ${bot?.displayName}</strong>
                <p style="font-size:0.875rem; margin-top:4px; color:var(--text-sec);">All actions will be performed as this bot</p>
              </div>
              <button class="btn btn-small btn-danger" onclick="Dev.stopBotControl()">Stop Control</button>
            </div>
          `;
        } else if (impersonatingUser) {
          banner = `
            <div class="impersonation-banner">
              <div>
                <strong style="color:var(--warning);">üëª Impersonation Mode Active</strong>
                <p style="font-size:0.875rem; margin-top:4px; color:var(--text-sec);">Posting as <strong>${impersonatingUser.displayName}</strong> (@${impersonatingUser.username})</p>
              </div>
              <button class="btn btn-small btn-danger" onclick="Dev.stopImpersonating()">Stop</button>
            </div>
          `;
        } else if (currentUser.isGuest) {
          banner = `
            <div class="guest-banner">
              <div>
                <strong style="color:var(--guest);">üë§ Guest Mode</strong>
                <p style="font-size:0.875rem; margin-top:4px; color:var(--text-sec);">Your data will not be saved. Scroll down on login page to create a permanent account.</p>
              </div>
            </div>
          `;
        }
        
        const postingAs = botControlMode ? DB.getUsers().find(u => u.id === controlledBotId) : (impersonatingUser || currentUser);
        
        document.getElementById('app').innerHTML = `
          ${this.renderNav()}
          <main class="main">
            <div class="card">
              <div style="display:flex; align-items:center; gap:16px;">
                <div class="avatar ${currentUser.isBot ? 'bot' : ''} ${currentUser.isGuest ? 'guest' : ''}" style="width:60px; height:60px; font-size:1.5rem;">
                  ${currentUser.avatar ? `<img src="${currentUser.avatar}" style="width:100%; height:100%; object-fit:cover;">` : currentUser.displayName[0].toUpperCase()}
                </div>
                <div style="flex:1;">
                  <h2 style="font-size:1.25rem;">Welcome, ${currentUser.displayName}!</h2>
                  ${currentUser.isDev ? '<span style="color:var(--accent); font-size:0.875rem; font-weight:600;">üõ°Ô∏è Developer Mode</span>' : ''}
                  ${currentUser.isBot ? '<span style="color:#00ff88; font-size:0.875rem; font-weight:600;">ü§ñ Bot Account</span>' : ''}
                  ${currentUser.shadowBanned ? '<span style="color:var(--danger); font-size:0.875rem;">üîá Shadow Banned</span>' : ''}
                </div>
              </div>
            </div>
            
            ${banner}
            
            ${!currentUser.isGuest ? `
            <div class="card">
              <div class="create-post">
                <div class="avatar ${postingAs?.isBot ? 'bot' : ''} ${postingAs?.isGuest ? 'guest' : ''}" style="flex-shrink:0;">
                  ${postingAs?.avatar ? `<img src="${postingAs.avatar}" style="width:100%; height:100%; object-fit:cover;">` : postingAs?.displayName[0].toUpperCase()}
                </div>
                <div style="flex:1;">
                  <textarea id="post-content" placeholder="${botControlMode ? 'Posting as bot...' : (impersonatingUser ? `Posting as ${impersonatingUser.displayName}...` : 'What\'s on your mind?')}" style="background:transparent; border:none; color:var(--text); width:100%; min-height:80px; resize:vertical;"></textarea>
                  <div class="create-post-actions">
                    <label class="media-btn" style="cursor:pointer; color:var(--accent);">
                      üì∑ Media
                      <input type="file" id="post-media" accept="image/*,video/*" style="display:none;" onchange="Posts.previewMedia(event)">
                    </label>
                    <button class="btn" onclick="Posts.create()">Post</button>
                  </div>
                  <div id="media-preview"></div>
                </div>
              </div>
            </div>
            ` : '<div class="card" style="text-align:center; padding:20px; color:var(--text-sec);">Guests can view but not post. <a href="#" onclick="Router.showAuth(); return false;" style="color:var(--accent);">Create an account</a> to join the conversation!</div>'}
            
            <div id="posts-container">
              ${posts.length === 0 
                ? '<div class="card empty-state"><div style="font-size:3rem; margin-bottom:16px;">üåå</div><p>No posts yet. Start the conversation!</p></div>'
                : posts.map(post => this.renderPost(post)).join('')
              }
            </div>
          </main>
        `;
      },
      
      renderPost(post) {
        const users = DB.getUsers();
        const author = users.find(u => u.id === post.userId) || {};
        const isLiked = post.likes.includes(currentUser?.id);
        const isPermanent = post.permanent;
        const isImpersonated = post.isDevImpersonated;
        const isBotPost = author.isBot;
        const canDelete = currentUser?.isDev || (!isPermanent && post.userId === currentUser?.id) || (botControlMode && post.userId === controlledBotId);
        const canEdit = currentUser?.isDev || post.userId === currentUser?.id || (botControlMode && post.userId === controlledBotId);
        
        if (author.shadowBanned && post.userId !== currentUser?.id && !currentUser?.isDev) return '';
        
        return `
          <div class="card" data-post-id="${post.id}">
            <div class="post-header">
              <div class="avatar ${author.isBot ? 'bot' : ''} ${author.isGuest ? 'guest' : ''}" onclick="Router.navigate('profile/${author.username}')" style="cursor:pointer;">
                ${author.avatar 
                  ? `<img src="${author.avatar}" style="width:100%; height:100%; object-fit:cover;">`
                  : (author.displayName?.[0]?.toUpperCase() || 'U')
                }
              </div>
              <div class="post-meta">
                <h4 onclick="Router.navigate('profile/${author.username}')" style="cursor:pointer; color:var(--text);">
                  ${author.displayName || 'Unknown'}
                  ${author.isVerified ? '<span class="verified">‚úì</span>' : ''}
                  ${author.isDev ? '<span class="admin-badge">‚òÖ</span>' : ''}
                  ${author.isBot ? '<span class="bot-badge">ü§ñ</span>' : ''}
                  ${isImpersonated ? '<span class="badge badge-dev">üë®‚Äçüíª DEV</span>' : ''}
                  ${isPermanent ? '<span class="badge badge-permanent">üîí PERMANENT</span>' : ''}
                  ${author.isGuest ? '<span class="badge badge-guest">GUEST</span>' : ''}
                </h4>
                <span>@${author.username || 'unknown'} ¬∑ ${Utils.formatDate(post.createdAt)}</span>
              </div>
            </div>
            
            <div class="post-content">${Utils.escapeHtml(post.content)}</div>
            
            ${post.mediaUrl ? `
              <div class="post-media">
                ${post.type === 'video' 
                  ? `<video src="${post.mediaUrl}" controls style="max-height:500px;"></video>`
                  : `<img src="${post.mediaUrl}" style="max-height:500px; width:100%; object-fit:cover;">`
                }
              </div>
            ` : ''}
            
            <div class="post-actions">
              <div class="post-action ${isLiked ? 'liked' : ''}" onclick="Posts.like('${post.id}')">
                <span>${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                <span>${post.likes.length}</span>
              </div>
              <div class="post-action" onclick="Posts.toggleComments('${post.id}')">
                <span>üí¨</span>
                <span>${post.comments.length}</span>
              </div>
              ${canEdit ? `
                <div class="post-action" onclick="Posts.edit('${post.id}')" style="margin-left:auto;">
                  <span>‚úèÔ∏è</span>
                </div>
              ` : ''}
              ${canDelete ? `
                <div class="post-action delete" onclick="Posts.delete('${post.id}')" style="color:var(--danger);">
                  <span>üóëÔ∏è</span>
                </div>
              ` : ''}
            </div>
            
            <div class="comments-section" id="comments-${post.id}" style="display:none; margin-top:16px; padding-top:16px; border-top:1px solid rgba(255,255,255,0.1);">
              ${post.comments.map(c => {
                const commenter = users.find(u => u.id === c.userId) || {};
                if (commenter.shadowBanned && c.userId !== currentUser?.id && !currentUser?.isDev) return '';
                return `
                  <div class="comment">
                    <div class="avatar small ${commenter.isBot ? 'bot' : ''} ${commenter.isGuest ? 'guest' : ''}">
                      ${commenter.avatar ? `<img src="${commenter.avatar}">` : (commenter.displayName?.[0]?.toUpperCase() || 'U')}
                    </div>
                    <div style="background:var(--surface-light); padding:8px 12px; border-radius:12px; flex:1;">
                      <div style="font-weight:600; font-size:0.875rem; display:flex; align-items:center; gap:4px;">
                        ${commenter.displayName || 'Unknown'}
                        ${commenter.shadowBanned ? '<span class="badge badge-shadow">shadow</span>' : ''}
                      </div>
                      <p style="margin:0; font-size:0.875rem;">${Utils.escapeHtml(c.content)}</p>
                    </div>
                  </div>
                `;
              }).join('')}
              <div style="display:flex; gap:12px; margin-top:12px;">
                <div class="avatar small ${currentUser.isBot ? 'bot' : ''} ${currentUser.isGuest ? 'guest' : ''}">
                  ${currentUser.avatar ? `<img src="${currentUser.avatar}">` : currentUser.displayName[0].toUpperCase()}
                </div>
                <input type="text" id="comment-input-${post.id}" placeholder="Write a comment..." style="flex:1;" onkeypress="if(event.key==='Enter') Posts.comment('${post.id}')">
                <button class="btn btn-small" onclick="Posts.comment('${post.id}')">Post</button>
              </div>
            </div>
          </div>
        `;
      },
      
      showProfile(username) {
        const users = DB.getUsers();
        const profile = users.find(u => u.username === username);
        if (!profile) {
          Utils.showToast('User not found', 'error');
          Router.navigate('/');
          return;
        }
        
        const posts = DB.getPosts()
          .filter(p => p.userId === profile.id)
          .filter(p => !p.userId.shadowBanned || currentUser?.isDev || p.userId === currentUser?.id)
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        if (profile.shadowBanned && profile.id !== currentUser?.id && !currentUser?.isDev) {
          Utils.showToast('User not found', 'error');
          Router.navigate('/');
          return;
        }
        
        const isFollowing = profile.followers.includes(currentUser?.id);
        const isOwn = currentUser?.id === profile.id;
        const canControlBot = currentUser?.isDev && profile.isBot && !isOwn;
        
        document.getElementById('app').innerHTML = `
          ${this.renderNav()}
          <main class="main" style="max-width:800px;">
            <div class="card profile-header" style="padding:0; border:none;">
              <div class="cover-image"></div>
              <div class="profile-info">
                <div class="profile-avatar-wrapper">
                  <div class="avatar large ${profile.isBot ? 'bot' : ''} ${profile.isGuest ? 'guest' : ''}">
                    ${profile.avatar 
                      ? `<img src="${profile.avatar}" style="width:100%; height:100%; object-fit:cover;">`
                      : profile.displayName[0].toUpperCase()
                    }
                  </div>
                  ${currentUser?.isDev && profile.shadowBanned ? '<div style="position:absolute; bottom:0; right:-10px; background:var(--danger); color:white; padding:4px 8px; border-radius:8px; font-size:0.75rem; font-weight:bold;">SHADOW BANNED</div>' : ''}
                </div>
                <div class="profile-name">
                  <h1>${profile.displayName}</h1>
                  ${profile.isVerified ? '<span class="verified" style="width:22px; height:22px; font-size:12px;">‚úì</span>' : ''}
                  ${profile.isDev ? '<span style="background:var(--accent); color:black; padding:2px 8px; border-radius:6px; font-size:0.75rem; font-weight:bold;">DEV</span>' : ''}
                  ${profile.isBot ? '<span style="background:#00ff88; color:black; padding:2px 8px; border-radius:6px; font-size:0.75rem; font-weight:bold;">ü§ñ BOT</span>' : ''}
                  ${profile.isGuest ? '<span style="background:var(--guest); color:white; padding:2px 8px; border-radius:6px; font-size:0.75rem; font-weight:bold;">GUEST</span>' : ''}
                </div>
                <p style="color:var(--text-sec);">@${profile.username}</p>
                ${profile.bio ? `<p style="margin-top:12px; color:var(--text);">${Utils.escapeHtml(profile.bio)}</p>` : ''}
                ${profile.shadowBanned ? '<p style="color:var(--danger); font-size:0.875rem; margin-top:8px;">üîá Account restricted</p>' : ''}
                
                <div class="profile-stats">
                  <div onclick="Router.navigate('profile/${profile.username}')" style="cursor:pointer;">
                    <strong>${posts.length}</strong>
                    <span>Posts</span>
                  </div>
                  <div>
                    <strong>${profile.followers.length}</strong>
                    <span>Followers</span>
                  </div>
                  <div>
                    <strong>${profile.following.length}</strong>
                    <span>Following</span>
                  </div>
                </div>
                
                <div style="margin-top:20px; display:flex; gap:8px; flex-wrap:wrap;">
                  ${!isOwn && !profile.isGuest ? `
                    <button class="btn ${isFollowing ? 'btn-outline' : ''}" onclick="Users.follow('${profile.id}')">
                      ${isFollowing ? 'Following' : 'Follow'}
                    </button>
                  ` : ''}
                  ${isOwn && !profile.isGuest ? `
                    <button class="btn btn-outline" onclick="Router.navigate('settings')">Edit Profile</button>
                  ` : ''}
                  ${canControlBot ? `
                    <button class="btn btn-warning" onclick="Dev.controlBot('${profile.id}')">üéÆ Control Bot</button>
                  ` : ''}
                  ${currentUser?.isDev && !profile.isDev ? `
                    <button class="btn btn-small btn-danger" onclick="Dev.deleteUser('${profile.id}')">üóëÔ∏è Delete</button>
                  ` : ''}
                </div>
              </div>
            </div>
            
            <h3 style="margin:24px 0 16px;">Posts</h3>
            ${posts.length === 0 ? '<div class="card" style="text-align:center; padding:40px; color:var(--text-sec);"><p>No posts yet</p></div>' : posts.map(post => this.renderPost(post)).join('')}
          </main>
        `;
      },
      
      showDevPanel() {
        const users = DB.getUsers();
        const posts = DB.getPosts();
        const logs = SystemLog.getLogs();
        
        const bots = users.filter(u => u.isBot);
        const realUsers = users.filter(u => !u.isBot && !u.isDev);
        
        const storageUsed = new Blob([JSON.stringify(localStorage)]).size;
        
        const stats = {
          totalUsers: users.length,
          totalPosts: posts.length,
          onlineUsers: users.filter(u => u.isOnline).length,
          bots: bots.length,
          permanentPosts: posts.filter(p => p.permanent).length,
          shadowBanned: users.filter(u => u.shadowBanned).length
        };
        
        const userOptions = realUsers.map(u => 
          `<option value="${u.id}">${u.displayName} (@${u.username}) ${u.shadowBanned ? '[SHADOW BANNED]' : ''}</option>`
        ).join('');
        
        const recentLogs = logs.slice(0, 20).map(log => {
          const time = new Date(log.time).toLocaleTimeString();
          return `
            <div class="log-entry">
              <span class="log-time">${time}</span>
              <span class="log-type">[${log.type}]</span>
              <span class="log-msg">${log.message} ${log.data?.username ? `(${log.data.username})` : ''}</span>
            </div>
          `;
        }).join('');
        
        document.getElementById('app').innerHTML = `
          ${this.renderNav()}
          <main class="main wide">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px;">
              <div>
                <h1 style="font-size:2rem; margin-bottom:8px;">üõ°Ô∏è Developer Console</h1>
                <p style="color:var(--text-sec);">System Administration & Control</p>
              </div>
              <button class="btn btn-outline" onclick="Router.navigate('dev')">üîÑ Refresh</button>
            </div>
            
            <div class="dev-grid">
              <div class="dev-card">
                <h3>üë• Users</h3>
                <div class="stat-value">${stats.totalUsers}</div>
                <p style="color:var(--text-sec); font-size:0.875rem; margin-top:8px;">
                  ${stats.onlineUsers} online<br>
                  ${stats.bots} bots<br>
                  ${stats.shadowBanned} shadow banned
                </p>
              </div>
              <div class="dev-card">
                <h3>üìù Posts</h3>
                <div class="stat-value">${stats.totalPosts}</div>
                <p style="color:var(--text-sec); font-size:0.875rem; margin-top:8px;">
                  ${stats.permanentPosts} permanent
                </p>
              </div>
              <div class="dev-card">
                <h3>üíæ Storage</h3>
                <div class="stat-value">${Utils.formatBytes(storageUsed)}</div>
                <p style="color:var(--text-sec); font-size:0.875rem; margin-top:8px;">
                  LocalStorage used
                </p>
              </div>
              <div class="dev-card">
                <h3>‚ö° Actions</h3>
                <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
                  <button class="btn btn-small" onclick="Dev.exportData()">üì• Export All Data</button>
                  <button class="btn btn-small" onclick="Dev.showImportModal()">üì§ Import Data</button>
                  <button class="btn btn-small btn-danger" onclick="Dev.purgeAll()">üí• Purge Everything</button>
                </div>
              </div>
            </div>
            
            <!-- Bot Management -->
            <div class="card" style="background:linear-gradient(135deg, rgba(0,255,136,0.1), transparent); border:1px solid #00ff88;">
              <h3 style="color:#00ff88; margin-bottom:16px;">ü§ñ Bot Management</h3>
              <div style="display:flex; gap:12px; margin-bottom:16px;">
                <input type="text" id="bot-username" placeholder="Bot username" style="flex:1;">
                <input type="text" id="bot-display" placeholder="Display name (optional)" style="flex:1;">
                <button class="btn" onclick="Dev.createBot()">Create Bot</button>
              </div>
              ${bots.length > 0 ? `
                <div style="display:flex; flex-direction:column; gap:8px;">
                  ${bots.map(bot => `
                    <div style="display:flex; align-items:center; justify-content:space-between; background:rgba(0,0,0,0.3); padding:12px; border-radius:8px;">
                      <div style="display:flex; align-items:center; gap:12px;">
                        <div class="avatar small bot">${bot.displayName[0].toUpperCase()}</div>
                        <div>
                          <div style="font-weight:600;">${bot.displayName}</div>
                          <div style="font-size:0.875rem; color:var(--text-sec);">@${bot.username} ¬∑ ${bot.isOnline ? 'üü¢ Online' : '‚ö™ Offline'}</div>
                        </div>
                      </div>
                      <div class="bot-controls">
                        <button class="btn btn-small btn-warning" onclick="Dev.controlBot('${bot.id}')">üéÆ Control</button>
                        <button class="btn btn-small btn-outline" onclick="Dev.impersonate('${bot.id}')">üëª Impersonate</button>
                        <button class="btn btn-small btn-danger" onclick="Dev.deleteUser('${bot.id}')">üóëÔ∏è Delete</button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : '<p style="color:var(--text-sec); text-align:center; padding:20px;">No bots created yet</p>'}
            </div>
            
            <!-- Impersonation -->
            <div class="card" style="background:linear-gradient(135deg, rgba(255,221,87,0.1), transparent); border:1px solid var(--warning); margin-top:20px;">
              <h3 style="color:var(--warning); margin-bottom:16px;">üëª Account Impersonation</h3>
              <div style="display:flex; gap:12px; align-items:end; flex-wrap:wrap;">
                <div style="flex:1; min-width:200px;">
                  <select id="impersonate-target" style="width:100%; background:var(--bg);">
                    <option value="">Select user to impersonate...</option>
                    ${userOptions}
                  </select>
                </div>
                <button class="btn btn-warning" onclick="Dev.startImpersonating()">Start Impersonating</button>
              </div>
              ${impersonatingUser ? `
                <div style="margin-top:16px; padding:12px; background:rgba(0,0,0,0.3); border-radius:8px; display:flex; align-items:center; justify-content:space-between;">
                  <span>Currently impersonating: <strong>${impersonatingUser.displayName}</strong></span>
                  <button class="btn btn-small btn-danger" onclick="Dev.stopImpersonating()">Stop</button>
                </div>
              ` : ''}
            </div>
            
            <!-- User Management Table -->
            <div class="card" style="padding:0; overflow:hidden; margin-top:24px;">
              <div style="padding:20px; border-bottom:1px solid rgba(255,255,255,0.1);">
                <h3>User Management</h3>
              </div>
              <div style="overflow-x:auto;">
                <table style="width:100%; border-collapse:collapse; font-size:0.875rem;">
                  <thead>
                    <tr style="background:var(--surface-light);">
                      <th style="padding:12px; text-align:left;">User</th>
                      <th style="padding:12px; text-align:left;">Status</th>
                      <th style="padding:12px; text-align:left;">Role</th>
                      <th style="padding:12px; text-align:left;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${users.filter(u => !u.isDev).map(u => `
                      <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                        <td style="padding:12px;">
                          <div style="display:flex; align-items:center; gap:12px;">
                            <div class="avatar small ${u.isBot ? 'bot' : ''} ${u.isGuest ? 'guest' : ''}">
                              ${u.avatar ? `<img src="${u.avatar}">` : u.displayName[0].toUpperCase()}
                            </div>
                            <div>
                              <div style="font-weight:600; display:flex; align-items:center; gap:4px;">
                                ${u.displayName}
                                ${u.isVerified ? '<span style="color:var(--accent);">‚úì</span>' : ''}
                              </div>
                              <div style="color:var(--text-sec); font-size:0.8rem;">@${u.username}</div>
                              ${u.lastIP ? `<div style="color:var(--text-sec); font-size:0.75rem; margin-top:2px;">IP: ${u.lastIP}</div>` : ''}
                            </div>
                          </div>
                        </td>
                        <td style="padding:12px;">
                          <div style="display:flex; align-items:center; gap:6px;">
                            <span style="display:inline-block; width:8px; height:8px; background:${u.isOnline ? 'var(--success)' : 'var(--text-sec)'}; border-radius:50%;"></span>
                            <span style="font-size:0.875rem; color:var(--text-sec);">${u.isOnline ? 'Online' : 'Offline'}</span>
                          </div>
                          ${u.shadowBanned ? '<div style="color:var(--danger); font-size:0.75rem; margin-top:4px;">üîá Shadow Banned</div>' : ''}
                          ${u.banned ? '<div style="color:var(--danger); font-size:0.75rem; margin-top:4px;">üö´ Banned</div>' : ''}
                        </td>
                        <td style="padding:12px;">
                          ${u.isBot ? '<span style="background:#00ff88; color:black; padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:bold;">ü§ñ BOT</span>' : 
                            u.isGuest ? '<span style="background:var(--guest); color:white; padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:bold;">GUEST</span>' : 
                            '<span style="color:var(--text-sec);">User</span>'}
                        </td>
                        <td style="padding:12px;">
                          <div style="display:flex; gap:6px; flex-wrap:wrap;">
                            <button class="btn btn-small" onclick="Dev.verify('${u.id}', ${!u.isVerified})" title="Verify">${u.isVerified ? '‚úì Unverify' : '‚úì Verify'}</button>
                            <button class="btn btn-small ${u.shadowBanned ? '' : 'btn-outline'}" onclick="Dev.shadowBan('${u.id}', ${!u.shadowBanned})" title="Shadow Ban" style="${u.shadowBanned ? 'background:#333; color:#999;' : ''}">
                              ${u.shadowBanned ? 'üîá Unshadow' : 'üîá Shadow'}
                            </button>
                            <button class="btn btn-small ${u.banned ? 'btn-danger' : 'btn-outline'}" onclick="Dev.ban('${u.id}', ${!u.banned})">
                              ${u.banned ? 'Unban' : 'Ban'}
                            </button>
                            <button class="btn btn-small btn-danger" onclick="Dev.massDeletePosts('${u.id}')">üóëÔ∏è Posts</button>
                            ${!u.isBot ? `<button class="btn btn-small btn-warning" onclick="Dev.impersonate('${u.id}')">üëª</button>` : ''}
                          </div>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- System Logs -->
            <div class="card" style="margin-top:24px;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h3>üìú System Logs (Last 20)</h3>
                <button class="btn btn-small btn-outline" onclick="SystemLog.clear(); Router.navigate('dev');">Clear Logs</button>
              </div>
              <div class="log-container">
                ${recentLogs || '<div style="color:var(--text-sec); text-align:center; padding:20px;">No logs yet</div>'}
              </div>
            </div>
          </main>
        `;
      }
    };
    
    const Auth = {
      async handleLogin(e) {
        if (e && e.preventDefault) e.preventDefault();
        
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        const errorDiv = document.getElementById('login-error');
        
        try {
          const users = DB.getUsers();
          const user = users.find(u => u.username === username && u.password === password);
          
          if (!user) {
            errorDiv.textContent = '‚ùå Invalid credentials';
            errorDiv.classList.add('show');
            errorDiv.style.display = 'block';
            SystemLog.add('AUTH_FAIL', 'Failed login attempt', { username });
            return false;
          }
          
          if (user.banned) {
            errorDiv.textContent = `üö´ Account banned: ${user.banReason}`;
            errorDiv.classList.add('show');
            errorDiv.style.display = 'block';
            return false;
          }
          
          user.isOnline = true;
          user.lastActive = new Date().toISOString();
          user.lastIP = '192.168.x.' + Math.floor(Math.random() * 255);
          await DB.saveUsers(users);
          
          currentUser = user;
          DB.saveCurrentUser(user);
          Utils.showToast(`Welcome back, ${user.displayName}!`);
          SystemLog.add('AUTH', 'User logged in', { username: user.username, id: user.id });
          Router.navigate('/');
        } catch (err) {
          console.error('Login error:', err);
          errorDiv.textContent = '‚ùå Login failed. Please try again.';
          errorDiv.classList.add('show');
          errorDiv.style.display = 'block';
        }
        return false;
      },
      
      handleRegister(e) {
        if (e && e.preventDefault) e.preventDefault();
        
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value;
        const errorDiv = document.getElementById('register-error');
        
        errorDiv.classList.remove('show');
        errorDiv.textContent = '';
        errorDiv.style.display = 'none';
        
        if (!username || !password) {
          errorDiv.textContent = "‚ùå Username and password required";
          errorDiv.classList.add('show');
          errorDiv.style.display = 'block';
          return false;
        }
        
        if (password.length < 4) {
          errorDiv.textContent = "‚ùå Password must be at least 4 characters";
          errorDiv.classList.add('show');
          errorDiv.style.display = 'block';
          return false;
        }
        
        if (!/^[a-zA-Z0-9_]+$/.test(username)) {
          errorDiv.textContent = "‚ùå Username can only contain letters, numbers, and underscores";
          errorDiv.classList.add('show');
          errorDiv.style.display = 'block';
          return false;
        }
        
        const processRegistration = async () => {
          try {
            const users = DB.getUsers();
            
            if (users.find(u => u.username === username)) {
              errorDiv.textContent = '‚ùå Username already taken';
              errorDiv.classList.add('show');
              errorDiv.style.display = 'block';
              return;
            }
            
            const newUser = {
              username,
              email: `${username}@user.netsphere`,
              password,
              displayName: username,
              bio: '',
              avatar: null,
              cover: null,
              isVerified: false,
              isAdmin: false,
              isDev: false,
              isBot: false,
              isGuest: false,
              isOnline: true,
              status: 'online',
              createdAt: new Date().toISOString(),
              followers: [],
              following: [],
              posts: 0,
              banned: false,
              shadowBanned: false,
              banReason: null,
              lastIP: null,
              metadata: {}
            };
            
            const createdUser = await DB.createUser(newUser);
            SystemLog.add('AUTH', 'New user registered', { username });
            
            currentUser = createdUser;
            DB.saveCurrentUser(createdUser);
            Utils.showToast('Account created successfully!', 'success');
            Router.navigate('/');
          } catch (err) {
            console.error('Registration error:', err);
            errorDiv.textContent = '‚ùå Failed to create account. Please try again.';
            errorDiv.classList.add('show');
            errorDiv.style.display = 'block';
          }
        };
        
        processRegistration();
        return false;
      },
      
      async loginAsGuest() {
        const guestId = Utils.generateId();
        const guestUser = {
          id: guestId,
          username: `guest_${guestId.substr(0, 6)}`,
          email: `guest_${guestId.substr(0, 6)}@guest.netsphere`,
          password: Utils.generateId(),
          displayName: 'Guest User',
          bio: 'Temporary guest account',
          avatar: null,
          cover: null,
          isVerified: false,
          isAdmin: false,
          isDev: false,
          isBot: false,
          isGuest: true,
          isOnline: true,
          status: 'online',
          createdAt: new Date().toISOString(),
          followers: [],
          following: [],
          posts: 0,
          banned: false,
          shadowBanned: false,
          banReason: null,
          lastIP: null,
          metadata: {}
        };
        
        const users = DB.getUsers();
        users.push(guestUser);
        await DB.saveUsers(users);
        
        currentUser = guestUser;
        DB.saveCurrentUser(guestUser);
        SystemLog.add('AUTH', 'Guest login', { username: guestUser.username });
        Utils.showToast('Welcome, Guest!', 'success');
        Router.navigate('/');
      },
      
      logout() {
        if (currentUser) {
          if (currentUser.isGuest) {
            DB.deleteUser(currentUser.id).then(() => {
              SystemLog.add('AUTH', 'Guest session ended', { username: currentUser.username });
            });
          } else {
            const users = DB.getUsers();
            const idx = users.findIndex(u => u.id === currentUser.id);
            if (idx !== -1) {
              users[idx].isOnline = false;
              DB.saveUsers(users);
            }
            SystemLog.add('AUTH', 'User logged out', { username: currentUser.username });
          }
        }
        botControlMode = false;
        controlledBotId = null;
        impersonatingUser = null;
        currentUser = null;
        DB.saveCurrentUser(null);
        Utils.showToast('Logged out');
        Router.showAuth();
      }
    };
    
    const Users = {
      async follow(userId) {
        const users = DB.getUsers();
        const currentIdx = users.findIndex(u => u.id === currentUser.id);
        const targetIdx = users.findIndex(u => u.id === userId);
        
        if (currentIdx === -1 || targetIdx === -1) return;
        
        const isFollowing = users[currentIdx].following.includes(userId);
        
        if (isFollowing) {
          users[currentIdx].following = users[currentIdx].following.filter(id => id !== userId);
          users[targetIdx].followers = users[targetIdx].followers.filter(id => id !== currentUser.id);
          Utils.showToast('Unfollowed');
        } else {
          users[currentIdx].following.push(userId);
          users[targetIdx].followers.push(currentUser.id);
          Utils.showToast('Following!');
        }
        
        await DB.saveUsers(users);
        currentUser = users[currentIdx];
        DB.saveCurrentUser(currentUser);
        SystemLog.add('SOCIAL', `${isFollowing ? 'Unfollowed' : 'Followed'} user`, { target: users[targetIdx].username });
        Router.handle();
      },
      
      updateAvatar(e) {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 2 * 1024 * 1024) {
          Utils.showToast('Image too large. Max 2MB', 'error');
          return;
        }
        const reader = new FileReader();
        reader.onload = async (event) => {
          const updated = await DB.updateUser(currentUser.id, { avatar: event.target.result });
          if (updated) {
            currentUser = updated;
            DB.saveCurrentUser(currentUser);
            SystemLog.add('PROFILE', 'Avatar updated', { username: currentUser.username });
            Utils.showToast('Profile picture updated!', 'success');
            Views.showSettings();
          }
        };
        reader.readAsDataURL(file);
      },
      
      async removeAvatar() {
        if (!confirm('Remove profile picture?')) return;
        const updated = await DB.updateUser(currentUser.id, { avatar: null });
        if (updated) {
          currentUser = updated;
          DB.saveCurrentUser(currentUser);
          Utils.showToast('Profile picture removed');
          Views.showSettings();
        }
      },
      
      async saveSettings(e) {
        if (e && e.preventDefault) e.preventDefault();
        const name = document.getElementById('settings-name').value;
        const bio = document.getElementById('settings-bio')?.value;
        
        const updated = await DB.updateUser(currentUser.id, {
          displayName: name,
          bio: bio || ''
        });
        
        if (updated) {
          currentUser = updated;
          DB.saveCurrentUser(currentUser);
          Utils.showToast('Settings saved!', 'success');
          SystemLog.add('PROFILE', 'Profile updated', { username: currentUser.username });
        }
      },
      
      async deleteAccount() {
        if (!confirm('‚ö†Ô∏è DELETE ACCOUNT?\n\nThis will permanently remove all your data. This cannot be undone!\n\nType "DELETE" to confirm.')) return;
        if (prompt('Type DELETE to confirm:') !== 'DELETE') {
          Utils.showToast('Account deletion cancelled', 'error');
          return;
        }
        await DB.deleteUser(currentUser.id);
        SystemLog.add('ADMIN', 'User deleted own account', { username: currentUser.username });
        Auth.logout();
        Utils.showToast('Account deleted permanently');
      }
    };
    
    const Posts = {
      previewMedia(e) {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 5 * 1024 * 1024) {
          Utils.showToast('File too large. Max 5MB.', 'error');
          return;
        }
        currentMediaFile = file;
        const reader = new FileReader();
        reader.onload = (event) => {
          const preview = document.getElementById('media-preview');
          preview.innerHTML = `
            <div style="margin-top:12px; position:relative; display:inline-block;">
              ${file.type.startsWith('video/') 
                ? `<video src="${event.target.result}" controls style="max-height:200px; border-radius:12px;"></video>`
                : `<img src="${event.target.result}" style="max-height:200px; border-radius:12px;">`
              }
              <button onclick="Posts.clearMedia()" style="position:absolute; top:8px; right:8px; background:var(--danger); color:white; border:none; width:28px; height:28px; border-radius:50%; cursor:pointer;">√ó</button>
            </div>
          `;
        };
        reader.readAsDataURL(file);
      },
      
      clearMedia() {
        currentMediaFile = null;
        document.getElementById('post-media').value = '';
        document.getElementById('media-preview').innerHTML = '';
      },
      
      async create() {
        const content = document.getElementById('post-content').value;
        if (!content.trim() && !currentMediaFile) {
          Utils.showToast('Write something first!', 'error');
          return;
        }
        
        const postingAs = botControlMode ? DB.getUsers().find(u => u.id === controlledBotId) : (impersonatingUser || currentUser);
        const isImpersonating = !!impersonatingUser && !botControlMode;
        const isBotControl = botControlMode;
        
        if (!postingAs) {
          Utils.showToast('Error: Cannot determine posting user', 'error');
          return;
        }
        
        const posts = DB.getPosts();
        const newPost = {
          id: Utils.generateId(),
          userId: postingAs.id,
          content: content,
          type: currentMediaFile ? (currentMediaFile.type.startsWith('video/') ? 'video' : 'image') : 'text',
          mediaUrl: null,
          likes: [],
          comments: [],
          shares: 0,
          createdAt: new Date().toISOString(),
          isDevImpersonated: isImpersonating,
          isBotControlled: isBotControl,
          permanent: isImpersonating || isBotControl,
          originalPosterId: (isImpersonating || isBotControl) ? currentUser.id : null
        };
        
        const savePost = async () => {
          posts.unshift(newPost);
          await DB.savePosts(posts);
          
          const users = DB.getUsers();
          const idx = users.findIndex(u => u.id === postingAs.id);
          if (idx !== -1) {
            users[idx].posts = (users[idx].posts || 0) + 1;
            await DB.saveUsers(users);
          }
          
          currentMediaFile = null;
          SystemLog.add('POST', `${isBotControl ? 'Bot controlled' : (isImpersonating ? 'Impersonated' : 'Created')} post`, { user: postingAs.username, postId: newPost.id });
          
          if (isBotControl) {
            Utils.showToast(`ü§ñ Posted as bot ${postingAs.displayName}`, 'success');
          } else if (isImpersonating) {
            Utils.showToast(`üîí Posted as ${postingAs.displayName} (PERMANENT)`, 'success');
          } else {
            Utils.showToast('Posted!', 'success');
          }
          
          Router.navigate('/');
        };
        
        if (currentMediaFile) {
          const reader = new FileReader();
          reader.onload = async (e) => {
            newPost.mediaUrl = e.target.result;
            await savePost();
          };
          reader.readAsDataURL(currentMediaFile);
        } else {
          await savePost();
        }
      },
      
      async like(postId) {
        if (currentUser.isGuest) {
          Utils.showToast('Guests cannot like posts', 'error');
          return;
        }
        const posts = DB.getPosts();
        const idx = posts.findIndex(p => p.id === postId);
        if (idx === -1) return;
        
        const isLiked = posts[idx].likes.includes(currentUser.id);
        if (isLiked) {
          posts[idx].likes = posts[idx].likes.filter(id => id !== currentUser.id);
        } else {
          posts[idx].likes.push(currentUser.id);
        }
        await DB.savePosts(posts);
        Router.handle();
      },
      
      toggleComments(postId) {
        const el = document.getElementById(`comments-${postId}`);
        if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
      },
      
      async comment(postId) {
        if (currentUser.isGuest) {
          Utils.showToast('Guests cannot comment', 'error');
          return;
        }
        const input = document.getElementById(`comment-input-${postId}`);
        const content = input.value.trim();
        if (!content) return;
        
        const posts = DB.getPosts();
        const idx = posts.findIndex(p => p.id === postId);
        if (idx === -1) return;
        
        posts[idx].comments.push({
          id: Utils.generateId(),
          userId: botControlMode ? controlledBotId : currentUser.id,
          content,
          createdAt: new Date().toISOString()
        });
        await DB.savePosts(posts);
        SystemLog.add('COMMENT', 'Comment added', { postId });
        Router.handle();
      },
      
      async delete(postId) {
        const posts = DB.getPosts();
        const post = posts.find(p => p.id === postId);
        if (!post) return;
        
        if (post.permanent && !currentUser.isDev && !botControlMode) {
          Utils.showToast('This post is permanent', 'error');
          return;
        }
        
        if (!confirm(post.permanent ? '‚ö†Ô∏è Delete PERMANENT post?' : 'Delete this post?')) return;
        
        let newPosts = posts.filter(p => p.id !== postId);
        await DB.savePosts(newPosts);
        
        const users = DB.getUsers();
        const userIdx = users.findIndex(u => u.id === post.userId);
        if (userIdx !== -1) {
          users[userIdx].posts = Math.max(0, (users[userIdx].posts || 0) - 1);
          await DB.saveUsers(users);
        }
        
        SystemLog.add('ADMIN', 'Post deleted', { postId, by: currentUser.username });
        Utils.showToast('Post deleted');
        Router.navigate('/');
      },
      
      async edit(postId) {
        const posts = DB.getPosts();
        const post = posts.find(p => p.id === postId);
        if (!post) return;
        
        if (!currentUser.isDev && post.userId !== currentUser.id && !(botControlMode && post.userId === controlledBotId)) {
          Utils.showToast('Cannot edit this post', 'error');
          return;
        }
        
        const newContent = prompt('Edit post:', post.content);
        if (newContent === null) return;
        if (!newContent.trim()) {
          Utils.showToast('Post cannot be empty', 'error');
          return;
        }
        
        post.content = newContent;
        post.editedAt = new Date().toISOString();
        post.editedBy = currentUser.id;
        await DB.savePosts(posts);
        SystemLog.add('ADMIN', 'Post edited', { postId, by: currentUser.username });
        Utils.showToast('Post updated');
        Router.handle();
      }
    };
    
    const Dev = {
      async createBot() {
        const usernameInput = document.getElementById('bot-username');
        const displayInput = document.getElementById('bot-display');
        const username = usernameInput.value.trim();
        const displayName = displayInput.value.trim() || username;
        
        if (!username) {
          Utils.showToast('Bot username required', 'error');
          return;
        }
        
        if (!/^[a-zA-Z0-9_]+$/.test(username)) {
          Utils.showToast('Username can only contain letters, numbers, and underscores', 'error');
          return;
        }
        
        const users = DB.getUsers();
        if (users.find(u => u.username === username)) {
          Utils.showToast('Username already exists', 'error');
          return;
        }
        
        const botUser = {
          username,
          email: `${username}@bot.netsphere`,
          password: Utils.generateId(),
          displayName,
          bio: 'ü§ñ Automated Bot Account',
          avatar: null,
          cover: null,
          isVerified: false,
          isAdmin: false,
          isDev: false,
          isBot: true,
          isGuest: false,
          isOnline: true,
          status: 'online',
          createdAt: new Date().toISOString(),
          followers: [],
          following: [],
          posts: 0,
          banned: false,
          shadowBanned: false,
          banReason: null,
          lastIP: '127.0.0.1',
          metadata: { createdBy: currentUser.id }
        };
        
        await DB.createUser(botUser);
        SystemLog.add('ADMIN', 'Bot created', { username, by: currentUser.username });
        Utils.showToast(`Bot ${displayName} created!`, 'success');
        Router.navigate('dev');
      },
      
      controlBot(botId) {
        const bot = DB.getUsers().find(u => u.id === botId);
        if (!bot || !bot.isBot) {
          Utils.showToast('Bot not found', 'error');
          return;
        }
        
        botControlMode = true;
        controlledBotId = botId;
        impersonatingUser = null;
        
        Utils.showToast(`üéÆ Now controlling ${bot.displayName}`, 'success');
        SystemLog.add('ADMIN', 'Started bot control', { bot: bot.username, by: currentUser.username });
        Router.navigate('/');
      },
      
      stopBotControl() {
        if (controlledBotId) {
          const bot = DB.getUsers().find(u => u.id === controlledBotId);
          SystemLog.add('ADMIN', 'Stopped bot control', { bot: bot?.username });
        }
        botControlMode = false;
        controlledBotId = null;
        Utils.showToast('Stopped controlling bot');
        Router.navigate('/');
      },
      
      verify(userId, verify) {
        DB.updateUser(userId, { isVerified: verify }).then(() => {
          SystemLog.add('ADMIN', `User ${verify ? 'verified' : 'unverified'}`, { userId });
          Utils.showToast(verify ? 'User verified' : 'Verification removed');
          Router.navigate('dev');
        });
      },
      
      ban(userId, ban) {
        if (ban) {
          const reason = prompt('Ban reason:');
          if (!reason) return;
          DB.updateUser(userId, { banned: true, banReason: reason }).then(() => {
            SystemLog.add('ADMIN', 'User banned', { userId, reason });
            Utils.showToast('User banned');
            Router.navigate('dev');
          });
        } else {
          DB.updateUser(userId, { banned: false, banReason: null }).then(() => {
            SystemLog.add('ADMIN', 'User unbanned', { userId });
            Utils.showToast('User unbanned');
            Router.navigate('dev');
          });
        }
      },
      
      shadowBan(userId, ban) {
        DB.updateUser(userId, { shadowBanned: ban }).then(() => {
          SystemLog.add('ADMIN', `User ${ban ? 'shadow banned' : 'unshadow banned'}`, { userId });
          Utils.showToast(ban ? 'üîá User shadow banned' : 'User restored');
          Router.navigate('dev');
        });
      },
      
      async massDeletePosts(userId) {
        if (!confirm('Delete ALL posts from this user?')) return;
        let posts = DB.getPosts().filter(p => p.userId !== userId);
        await DB.savePosts(posts);
        const users = DB.getUsers();
        const user = users.find(u => u.id === userId);
        if (user) {
          user.posts = 0;
          await DB.saveUsers(users);
        }
        SystemLog.add('ADMIN', 'Mass deleted user posts', { user: user?.username });
        Utils.showToast('All posts deleted');
        Router.navigate('dev');
      },
      
      async deleteUser(userId) {
        const user = DB.getUsers().find(u => u.id === userId);
        if (!user) return;
        
        if (!confirm(`Delete ${user.displayName} (@${user.username})?\n\nThis will remove the account and all posts. Cannot be undone!`)) return;
        
        await DB.deleteUser(userId);
        SystemLog.add('ADMIN', 'User deleted', { username: user.username, by: currentUser.username });
        
        if (controlledBotId === userId) {
          botControlMode = false;
          controlledBotId = null;
        }
        
        Utils.showToast('User deleted');
        Router.navigate('dev');
      },
      
      impersonate(userId) {
        const users = DB.getUsers();
        const target = users.find(u => u.id === userId);
        if (target) {
          impersonatingUser = target;
          botControlMode = false;
          controlledBotId = null;
          Utils.showToast(`Impersonating ${target.displayName}`, 'warning');
          SystemLog.add('ADMIN', 'Started impersonation', { target: target.username, by: currentUser.username });
          Router.navigate('/');
        }
      },
      
      startImpersonating() {
        const select = document.getElementById('impersonate-target');
        if (select && select.value) {
          this.impersonate(select.value);
        } else {
          Utils.showToast('Select a user', 'error');
        }
      },
      
      stopImpersonating() {
        if (impersonatingUser) {
          SystemLog.add('ADMIN', 'Stopped impersonation', { target: impersonatingUser.username });
          impersonatingUser = null;
          Utils.showToast('Stopped impersonating');
          Router.navigate('/');
        }
      },
      
      exportData() {
        const data = DB.exportAll();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `netsphere_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        SystemLog.add('SYSTEM', 'Data exported');
        Utils.showToast('Data exported!', 'success');
      },
      
      showImportModal() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay show';
        modal.innerHTML = `
          <div class="modal">
            <h3 style="color:var(--danger); margin-bottom:16px;">‚ö†Ô∏è Import Data</h3>
            <p style="color:var(--text-sec); margin-bottom:16px; font-size:0.875rem;">
              This will OVERWRITE all current data. Make sure you have a backup!
            </p>
            <input type="file" id="import-file" accept=".json" style="margin-bottom:16px;">
            <div style="display:flex; gap:12px;">
              <button class="btn btn-outline" style="flex:1;" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
              <button class="btn btn-danger" style="flex:1;" onclick="Dev.importData()">Import</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      },
      
      importData() {
        const file = document.getElementById('import-file').files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (DB.importAll(data)) {
              SystemLog.add('SYSTEM', 'Data imported');
              Utils.showToast('Data imported! Reloading...', 'success');
              setTimeout(() => location.reload(), 1500);
            } else {
              Utils.showToast('Invalid data format', 'error');
            }
          } catch(err) {
            Utils.showToast('Error reading file', 'error');
          }
        };
        reader.readAsText(file);
      },
      
      purgeAll() {
        if (!confirm('üí• DELETE EVERYTHING?\n\nThis wipes ALL users, posts, and logs.\nThis cannot be undone!\n\nType PURGE to confirm:')) return;
        if (prompt('Type PURGE to confirm:') !== 'PURGE') return;
        
        localStorage.removeItem(DB.KEYS.USERS);
        localStorage.removeItem(DB.KEYS.POSTS);
        localStorage.removeItem('ns_logs');
        localStorage.removeItem('ns_dev_unlocked');
        SystemLog.add('SYSTEM', 'COMPLETE DATA PURGE');
        Utils.showToast('Everything deleted. Reloading...', 'error');
        setTimeout(() => location.reload(), 2000);
      }
    };
    
    window.addEventListener('DOMContentLoaded', () => {
      Views.init();
    });
    
    window.addEventListener('hashchange', () => {
      Router.handle();
    });
    
    window.Router = Router;
    window.Posts = Posts;
    window.Users = Users;
    window.Dev = Dev;
    window.Auth = Auth;
    window.Views = Views;
    window.SystemLog = SystemLog;
    window.DB = DB;
  </script>
</body>
</html>
